/*! obs-model-validation 0.3.0 Copyright (c) 2013 Alan Plum. MIT licensed. @preserve */
function optionallyRequire(e,a){try{return require(e)}catch(n){return a}}var aug=require("aug"),equals=require("equals"),obs=require("obs"),XRegExp=optionallyRequire("xregexp",RegExp),isArray=Array.isArray?Array.isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"};if(XRegExp.XRegExp){XRegExp=XRegExp.XRegExp}function validation(e){var a=[],n,t,r;e.valid=obs.computed(function(){for(var a in e.model.attrs){if(!e[a].valid()){return false}}return true});for(n in e.model.attrs){t=e.model.attrs[n]||{};r=e[n];r.valid=obs.computed({read:validation.createValidator(t,r),context:e});r.valid.watch(r);e.valid.watch(r.valid);a.push(r)}for(n in e.model.validations){t=e.model.validations[n];for(var i=0;i<t.props.length;i++){r=e[t.props[i]];r.valid.read.validations.push(validation.createModelValidation(t,e));for(var u=0;u<t.props.length;u++){if(i===u){continue}r.valid.watch(e[t.props[u]])}}}for(n in e.model.attrs){e[n].notify()}e._destructors.push(function(){var n,t,r,i,u;for(n=0;n<a.length;n++){t=a[n];t.valid.unwatch(t);e.valid.unwatch(t.valid)}for(r in e.model.validations){i=e.model.validations[r];for(n=0;n<i.props.length;n++){t=e[i.props[n]];for(u=0;u<i.props.length;u++){if(n===u){continue}t.valid.unwatch(e[i.props[u]])}}}})}aug(validation,{EXEMPT:"exempt",createValidator:function(e,a){var n=[];n.push(function(a){if(a===null||a===undefined){return e.required?false:validation.EXEMPT}return true});if(e.values){n.push(function(a){for(var n=0;n<e.values.length;n++){if(equals(a,e.values[n])){return validation.EXEMPT}}return null})}if(e.type){n.push(function(a){if(isArray(e.type)){for(var n=0;n<e.type.length;n++){if(validation.hasType(e.type[n],a)){return true}}return false}else{return validation.hasType(e.type,a)}})}if(e.lengthRange){n.push(function(a){if(typeof a.length!=="number"){return false}if(e.lengthRange.min!==undefined){if(a.length<e.lengthRange.min){return false}}if(e.lengthRange.max!==undefined){if(a.length>e.lengthRange.max){return false}}return true})}if(e.valueRange){n.push(function(a){var n=0;if(typeof a!=="number"){return false}if(e.valueRange.min!==undefined){n=e.valueRange.min;if(e.valueRange.minExclusive){n+=1;if(a<=e.valueRange.min){return false}}else if(a<e.valueRange.min){return false}}if(e.valueRange.max!==undefined){if(e.valueRange.maxExclusive){if(a>=e.valueRange.max){return false}}else if(a>e.valueRange.max){return false}}if(e.valueRange.step!==undefined){return(a-n)%e.valueRange.step===0}if(e.valueRange.multipleOf!==undefined){return a%e.valueRange.multipleOf===0}return true})}if(e.pattern){var t=typeof e.pattern==="string"?new XRegExp(e.pattern):e.pattern;n.push(function(e){return t.test(e)})}if(e.validate){n.push(e.validate)}return aug(function(){var e=a(),t=true;for(var r=0;r<n.length;r++){t=n[r].call(this,e);if(t===validation.EXEMPT||t===false){return t===validation.EXEMPT}}return t===true},{validations:n})},createModelValidation:function(e,a){return function(){var n=[];for(var t=0;t<e.props.length;t++){n.push(a[e.props[t]]())}return e.validate.apply(a,n)}},contributeToModel:function(e){aug(e,{validations:[],validation:function(e,a){this.validations.push({validate:e,props:a});return this}})},hasType:function(e,a){if(e==="integer"){return typeof a==="number"&&a===Math.floor(a)}else if(typeof e==="string"){return typeof a===e}else{return a instanceof e}}});module.exports=validation;